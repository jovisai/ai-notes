<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Contextual RAG: Adding Context to Chunks for Better Retrieval - Engineering Notes</title><link rel="icon" type="image/jpeg" href=/avatar.jpeg />
	<link rel="apple-touch-icon" href=/avatar.jpeg /><meta name="viewport" content="width=device-width, initial-scale=1">
	
  <meta itemprop="name" content="Contextual RAG: Adding Context to Chunks for Better Retrieval">
  <meta itemprop="description" content="Improve your RAG pipeline by prepending contextual information to each chunk before embedding, reducing retrieval failures by up to 67%.">
  <meta itemprop="datePublished" content="2025-12-31T00:00:00+00:00">
  <meta itemprop="dateModified" content="2025-12-31T00:00:00+00:00">
  <meta itemprop="wordCount" content="1186">
  <meta itemprop="keywords" content="Ai,RAG,Retrieval,Python,Tutorial"><meta property="og:url" content="https://notes.muthu.co/2025/12/contextual-rag-adding-context-to-chunks-for-better-retrieval/">
  <meta property="og:site_name" content="Engineering Notes">
  <meta property="og:title" content="Contextual RAG: Adding Context to Chunks for Better Retrieval">
  <meta property="og:description" content="Improve your RAG pipeline by prepending contextual information to each chunk before embedding, reducing retrieval failures by up to 67%.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-12-31T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-12-31T00:00:00+00:00">
    <meta property="article:tag" content="Ai">
    <meta property="article:tag" content="RAG">
    <meta property="article:tag" content="Retrieval">
    <meta property="article:tag" content="Python">
    <meta property="article:tag" content="Tutorial">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Contextual RAG: Adding Context to Chunks for Better Retrieval">
  <meta name="twitter:description" content="Improve your RAG pipeline by prepending contextual information to each chunk before embedding, reducing retrieval failures by up to 67%.">
<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
	<link rel="stylesheet" type="text/css" media="screen" href="https://notes.muthu.co/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://notes.muthu.co/css/main.css" />
	<link rel="stylesheet" type="text/css" media="print" href="https://notes.muthu.co/css/print.css" />

	<link id="dark-scheme" rel="stylesheet" type="text/css" href="https://notes.muthu.co/css/dark.css" /><script src="https://notes.muthu.co/js/feather.min.js"></script>
	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css" crossorigin="anonymous">
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js" crossorigin="anonymous"></script>
	<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js" crossorigin="anonymous"
		onload="renderMathInElement(document.body, {delimiters:[{left:'$$',right:'$$',display:true},{left:'$',right:'$',display:false}]});"></script>
	<script src="https://notes.muthu.co/js/main.js"></script>
</head>


<body>


	
	<div class="container wrapper">
		<div class="header">
	
		<div class="avatar">
			<a href="https://notes.muthu.co/">
				<img src="/avatar.jpeg" alt="Engineering Notes" />
			</a>
		</div>
	
	<h1 class="site-title"><a href="https://notes.muthu.co/">Engineering Notes</a></h1>
	<div class="site-description"><p>Thoughts and Ideas on AI by Muthukrishnan</p><nav class="nav social">
			<ul class="flat"><li><a href="https://github.com/muthuspark/" title="Github"><i data-feather="github"></i></a></li><li><a href="https://linkedin.com/in/krimuthu/" title="LinkedIn"><i data-feather="linkedin"></i></a></li></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/ai-agents">AI Agents</a>
			</li>
			
			<li>
				<a href="/engineering-manager">Engineering Manager</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/resume">Resume</a>
			</li>
			
			<li>
				<a href="/tags">Tags &amp; Stats</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post">
    <div class="post-header">
    <div class="matter">
        <h1 class="title">Contextual RAG: Adding Context to Chunks for Better Retrieval</h1>
        
        <div class="date">
            <span class="day">31</span>
            <span class="rest">Dec 2025</span>
        </div>
        
    </div>
</div>


    
    
    <p>Standard RAG has a fundamental problem: chunks lose their context. When you split a document into pieces, each chunk becomes isolated. A sentence like &ldquo;The company increased revenue by 15%&rdquo; is meaningless without knowing which company, which year, and what the previous revenue was.</p>
<p>Contextual RAG solves this by enriching each chunk with surrounding context before embedding. Anthropic&rsquo;s research shows this technique can reduce retrieval failures by up to 67%.</p>
<h2 id="the-problem-with-standard-chunking">The Problem with Standard Chunking</h2>
<p>Consider this document:</p>
<pre tabindex="0"><code># Q3 2025 Financial Report

## Executive Summary
Revenue grew 15% year-over-year to $4.2 billion.

## Regional Performance
### North America
The region exceeded targets with $2.1 billion in sales.

### Europe
Growth slowed to 8% due to currency headwinds.
</code></pre><p>Standard chunking might create:</p>
<pre tabindex="0"><code>Chunk 1: &#34;Revenue grew 15% year-over-year to $4.2 billion.&#34;
Chunk 2: &#34;The region exceeded targets with $2.1 billion in sales.&#34;
Chunk 3: &#34;Growth slowed to 8% due to currency headwinds.&#34;
</code></pre><p>Now if a user asks &ldquo;How did the European region perform?&rdquo;, Chunk 3 might not be retrieved because it doesn&rsquo;t mention &ldquo;Europe&rdquo;â€”that context is in the header above.</p>
<h2 id="contextual-rag-solution">Contextual RAG Solution</h2>
<p>Before embedding, we prepend context to each chunk:</p>
<pre tabindex="0"><code>Chunk 1: &#34;This is from the Executive Summary section of the Q3 2025 Financial Report. Revenue grew 15% year-over-year to $4.2 billion.&#34;

Chunk 2: &#34;This is from the North America subsection of Regional Performance in the Q3 2025 Financial Report. The region exceeded targets with $2.1 billion in sales.&#34;

Chunk 3: &#34;This is from the Europe subsection of Regional Performance in the Q3 2025 Financial Report. Growth slowed to 8% due to currency headwinds.&#34;
</code></pre><p>Now &ldquo;Europe&rdquo; appears in Chunk 3, and retrieval succeeds.</p>
<h2 id="implementation">Implementation</h2>
<h3 id="step-1-generate-context-with-an-llm">Step 1: Generate Context with an LLM</h3>
<p>Use a language model to generate a brief context description for each chunk:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">openai</span> <span style="color:#cf222e">import</span> OpenAI
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>client <span style="color:#0550ae">=</span> OpenAI<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">generate_context</span><span style="color:#1f2328">(</span>document<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Generate contextual description for a chunk.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    prompt <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &lt;document&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    </span><span style="color:#0a3069">{</span>document<span style="color:#1f2328">[:</span><span style="color:#0550ae">3000</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">  # First part of document for context
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &lt;/document&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Here is a chunk from the document:
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &lt;chunk&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    </span><span style="color:#0a3069">{</span>chunk<span style="color:#0a3069">}</span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &lt;/chunk&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    Provide a brief (1-2 sentence) description of what this chunk is about
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    and where it fits in the document. This will be prepended to the chunk
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    for better search retrieval.
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response <span style="color:#0550ae">=</span> client<span style="color:#0550ae">.</span>chat<span style="color:#0550ae">.</span>completions<span style="color:#0550ae">.</span>create<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;gpt-4o-mini&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        messages<span style="color:#0550ae">=</span><span style="color:#1f2328">[{</span><span style="color:#0a3069">&#34;role&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">&#34;user&#34;</span><span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;content&#34;</span><span style="color:#1f2328">:</span> prompt<span style="color:#1f2328">}],</span>
</span></span><span style="display:flex;"><span>        max_tokens<span style="color:#0550ae">=</span><span style="color:#0550ae">100</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> response<span style="color:#0550ae">.</span>choices<span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>message<span style="color:#0550ae">.</span>content<span style="color:#0550ae">.</span>strip<span style="color:#1f2328">()</span>
</span></span></code></pre></div><h3 id="step-2-contextual-chunking-pipeline">Step 2: Contextual Chunking Pipeline</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">langchain.text_splitter</span> <span style="color:#cf222e">import</span> RecursiveCharacterTextSplitter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">create_contextual_chunks</span><span style="color:#1f2328">(</span>document<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> chunk_size<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">500</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Split document and add context to each chunk.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># Standard chunking</span>
</span></span><span style="display:flex;"><span>    splitter <span style="color:#0550ae">=</span> RecursiveCharacterTextSplitter<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        chunk_size<span style="color:#0550ae">=</span>chunk_size<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>        chunk_overlap<span style="color:#0550ae">=</span><span style="color:#0550ae">50</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    raw_chunks <span style="color:#0550ae">=</span> splitter<span style="color:#0550ae">.</span>split_text<span style="color:#1f2328">(</span>document<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    contextual_chunks <span style="color:#0550ae">=</span> <span style="color:#1f2328">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> i<span style="color:#1f2328">,</span> chunk <span style="color:#0550ae">in</span> <span style="color:#6639ba">enumerate</span><span style="color:#1f2328">(</span>raw_chunks<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Generate context</span>
</span></span><span style="display:flex;"><span>        context <span style="color:#0550ae">=</span> generate_context<span style="color:#1f2328">(</span>document<span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Create contextualized chunk</span>
</span></span><span style="display:flex;"><span>        contextual_chunk <span style="color:#0550ae">=</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>context<span style="color:#0a3069">}</span><span style="color:#0a3069">\n\n</span><span style="color:#0a3069">{</span>chunk<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        contextual_chunks<span style="color:#0550ae">.</span>append<span style="color:#1f2328">({</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">:</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;chunk_</span><span style="color:#0a3069">{</span>i<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;original&#34;</span><span style="color:#1f2328">:</span> chunk<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">:</span> context<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;contextual_text&#34;</span><span style="color:#1f2328">:</span> contextual_chunk
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> contextual_chunks
</span></span></code></pre></div><h3 id="step-3-embed-and-store">Step 3: Embed and Store</h3>
<p>Embed the contextualized text, not the original:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">chromadb</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">sentence_transformers</span> <span style="color:#cf222e">import</span> SentenceTransformer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>embedder <span style="color:#0550ae">=</span> SentenceTransformer<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;all-MiniLM-L6-v2&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>chroma_client <span style="color:#0550ae">=</span> chromadb<span style="color:#0550ae">.</span>Client<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>collection <span style="color:#0550ae">=</span> chroma_client<span style="color:#0550ae">.</span>create_collection<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;contextual_docs&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">index_contextual_chunks</span><span style="color:#1f2328">(</span>chunks<span style="color:#1f2328">:</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Index contextualized chunks in vector store.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> chunk <span style="color:#0550ae">in</span> chunks<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Embed the contextual text</span>
</span></span><span style="display:flex;"><span>        embedding <span style="color:#0550ae">=</span> embedder<span style="color:#0550ae">.</span>encode<span style="color:#1f2328">(</span>chunk<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;contextual_text&#34;</span><span style="color:#1f2328">])</span><span style="color:#0550ae">.</span>tolist<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        collection<span style="color:#0550ae">.</span>add<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            ids<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>chunk<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">]],</span>
</span></span><span style="display:flex;"><span>            embeddings<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>embedding<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            documents<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>chunk<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;original&#34;</span><span style="color:#1f2328">]],</span>  <span style="color:#57606a"># Store original for display</span>
</span></span><span style="display:flex;"><span>            metadatas<span style="color:#0550ae">=</span><span style="color:#1f2328">[{</span><span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">:</span> chunk<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">]}]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span></code></pre></div><h3 id="step-4-retrieval">Step 4: Retrieval</h3>
<p>At query time, you can optionally add context to the query too:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">contextual_search</span><span style="color:#1f2328">(</span>query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> n_results<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Search with optional query contextualization.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    query_embedding <span style="color:#0550ae">=</span> embedder<span style="color:#0550ae">.</span>encode<span style="color:#1f2328">(</span>query<span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>tolist<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    results <span style="color:#0550ae">=</span> collection<span style="color:#0550ae">.</span>query<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>        query_embeddings<span style="color:#0550ae">=</span><span style="color:#1f2328">[</span>query_embedding<span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>        n_results<span style="color:#0550ae">=</span>n_results
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#1f2328">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;text&#34;</span><span style="color:#1f2328">:</span> doc<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">:</span> meta<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> doc<span style="color:#1f2328">,</span> meta <span style="color:#0550ae">in</span> <span style="color:#6639ba">zip</span><span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            results<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;documents&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">0</span><span style="color:#1f2328">],</span>
</span></span><span style="display:flex;"><span>            results<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;metadatas&#34;</span><span style="color:#1f2328">][</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">]</span>
</span></span></code></pre></div><h2 id="optimization-caching-context-generation">Optimization: Caching Context Generation</h2>
<p>Generating context for every chunk is expensive. Cache the results:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">hashlib</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">json</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">pathlib</span> <span style="color:#cf222e">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CACHE_DIR <span style="color:#0550ae">=</span> Path<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;./context_cache&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>CACHE_DIR<span style="color:#0550ae">.</span>mkdir<span style="color:#1f2328">(</span>exist_ok<span style="color:#0550ae">=</span><span style="color:#cf222e">True</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">get_cached_context</span><span style="color:#1f2328">(</span>document<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span> <span style="color:#0550ae">|</span> <span style="color:#cf222e">None</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Check cache for existing context.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    cache_key <span style="color:#0550ae">=</span> hashlib<span style="color:#0550ae">.</span>md5<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>document<span style="color:#1f2328">[:</span><span style="color:#0550ae">500</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}{</span>chunk<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#0550ae">.</span>encode<span style="color:#1f2328">())</span><span style="color:#0550ae">.</span>hexdigest<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    cache_file <span style="color:#0550ae">=</span> CACHE_DIR <span style="color:#0550ae">/</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>cache_key<span style="color:#0a3069">}</span><span style="color:#0a3069">.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> cache_file<span style="color:#0550ae">.</span>exists<span style="color:#1f2328">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> json<span style="color:#0550ae">.</span>loads<span style="color:#1f2328">(</span>cache_file<span style="color:#0550ae">.</span>read_text<span style="color:#1f2328">())[</span><span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#cf222e">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">save_context_to_cache</span><span style="color:#1f2328">(</span>document<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> context<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Save generated context to cache.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    cache_key <span style="color:#0550ae">=</span> hashlib<span style="color:#0550ae">.</span>md5<span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>document<span style="color:#1f2328">[:</span><span style="color:#0550ae">500</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}{</span>chunk<span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#0550ae">.</span>encode<span style="color:#1f2328">())</span><span style="color:#0550ae">.</span>hexdigest<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>    cache_file <span style="color:#0550ae">=</span> CACHE_DIR <span style="color:#0550ae">/</span> <span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">{</span>cache_key<span style="color:#0a3069">}</span><span style="color:#0a3069">.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cache_file<span style="color:#0550ae">.</span>write_text<span style="color:#1f2328">(</span>json<span style="color:#0550ae">.</span>dumps<span style="color:#1f2328">({</span><span style="color:#0a3069">&#34;context&#34;</span><span style="color:#1f2328">:</span> context<span style="color:#1f2328">}))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">generate_context_with_cache</span><span style="color:#1f2328">(</span>document<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Generate context with caching.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    cached <span style="color:#0550ae">=</span> get_cached_context<span style="color:#1f2328">(</span>document<span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> cached<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> cached
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    context <span style="color:#0550ae">=</span> generate_context<span style="color:#1f2328">(</span>document<span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    save_context_to_cache<span style="color:#1f2328">(</span>document<span style="color:#1f2328">,</span> chunk<span style="color:#1f2328">,</span> context<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> context
</span></span></code></pre></div><h2 id="combining-with-bm25">Combining with BM25</h2>
<p>For even better retrieval, combine contextual embeddings with BM25:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">import</span> <span style="color:#24292e">numpy</span> <span style="color:#cf222e">as</span> <span style="color:#24292e">np</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">from</span> <span style="color:#24292e">rank_bm25</span> <span style="color:#cf222e">import</span> BM25Okapi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">class</span> <span style="color:#1f2328">HybridRetriever</span><span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">__init__</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> chunks<span style="color:#1f2328">:</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>chunks <span style="color:#0550ae">=</span> chunks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># BM25 on contextual text</span>
</span></span><span style="display:flex;"><span>        tokenized <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>c<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;contextual_text&#34;</span><span style="color:#1f2328">]</span><span style="color:#0550ae">.</span>split<span style="color:#1f2328">()</span> <span style="color:#cf222e">for</span> c <span style="color:#0550ae">in</span> chunks<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>bm25 <span style="color:#0550ae">=</span> BM25Okapi<span style="color:#1f2328">(</span>tokenized<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Vector store</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedder <span style="color:#0550ae">=</span> SentenceTransformer<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;all-MiniLM-L6-v2&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embeddings <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedder<span style="color:#0550ae">.</span>encode<span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#1f2328">[</span>c<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;contextual_text&#34;</span><span style="color:#1f2328">]</span> <span style="color:#cf222e">for</span> c <span style="color:#0550ae">in</span> chunks<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">def</span> <span style="color:#6639ba">search</span><span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#1f2328">,</span> query<span style="color:#1f2328">:</span> <span style="color:#6639ba">str</span><span style="color:#1f2328">,</span> n<span style="color:#1f2328">:</span> <span style="color:#6639ba">int</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">,</span> alpha<span style="color:#1f2328">:</span> <span style="color:#6639ba">float</span> <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.5</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">-&gt;</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">dict</span><span style="color:#1f2328">]:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#0a3069">&#34;&#34;&#34;Hybrid search with weighted combination.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># BM25 scores</span>
</span></span><span style="display:flex;"><span>        bm25_scores <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>bm25<span style="color:#0550ae">.</span>get_scores<span style="color:#1f2328">(</span>query<span style="color:#0550ae">.</span>split<span style="color:#1f2328">())</span>
</span></span><span style="display:flex;"><span>        bm25_scores <span style="color:#0550ae">=</span> bm25_scores <span style="color:#0550ae">/</span> bm25_scores<span style="color:#0550ae">.</span>max<span style="color:#1f2328">()</span>  <span style="color:#57606a"># Normalize</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Vector scores</span>
</span></span><span style="display:flex;"><span>        query_emb <span style="color:#0550ae">=</span> <span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embedder<span style="color:#0550ae">.</span>encode<span style="color:#1f2328">(</span>query<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        vector_scores <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>dot<span style="color:#1f2328">(</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>embeddings<span style="color:#1f2328">,</span> query_emb<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        vector_scores <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span>vector_scores <span style="color:#0550ae">-</span> vector_scores<span style="color:#0550ae">.</span>min<span style="color:#1f2328">())</span> <span style="color:#0550ae">/</span> <span style="color:#1f2328">(</span>
</span></span><span style="display:flex;"><span>            vector_scores<span style="color:#0550ae">.</span>max<span style="color:#1f2328">()</span> <span style="color:#0550ae">-</span> vector_scores<span style="color:#0550ae">.</span>min<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Combine scores</span>
</span></span><span style="display:flex;"><span>        combined <span style="color:#0550ae">=</span> alpha <span style="color:#0550ae">*</span> vector_scores <span style="color:#0550ae">+</span> <span style="color:#1f2328">(</span><span style="color:#0550ae">1</span> <span style="color:#0550ae">-</span> alpha<span style="color:#1f2328">)</span> <span style="color:#0550ae">*</span> bm25_scores
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#57606a"># Get top n</span>
</span></span><span style="display:flex;"><span>        top_indices <span style="color:#0550ae">=</span> np<span style="color:#0550ae">.</span>argsort<span style="color:#1f2328">(</span>combined<span style="color:#1f2328">)[</span><span style="color:#0550ae">-</span>n<span style="color:#1f2328">:][::</span><span style="color:#0550ae">-</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">return</span> <span style="color:#1f2328">[</span><span style="color:#6a737d">self</span><span style="color:#0550ae">.</span>chunks<span style="color:#1f2328">[</span>i<span style="color:#1f2328">]</span> <span style="color:#cf222e">for</span> i <span style="color:#0550ae">in</span> top_indices<span style="color:#1f2328">]</span>
</span></span></code></pre></div><h2 id="when-to-use-contextual-rag">When to Use Contextual RAG</h2>
<p><strong>Use it when:</strong></p>
<ul>
<li>Documents have hierarchical structure (headers, sections)</li>
<li>Chunks reference entities defined elsewhere</li>
<li>You&rsquo;re seeing retrieval failures on relevant content</li>
<li>Document length makes whole-document embedding impractical</li>
</ul>
<p><strong>Skip it when:</strong></p>
<ul>
<li>Documents are short and self-contained</li>
<li>Each chunk is naturally independent (e.g., FAQ entries)</li>
<li>Cost of context generation is prohibitive</li>
</ul>
<h2 id="cost-analysis">Cost Analysis</h2>
<p>Contextual RAG adds LLM costs at indexing time:</p>
<table>
  <thead>
      <tr>
          <th>Documents</th>
          <th>Chunks</th>
          <th>Context Calls</th>
          <th>Cost (GPT-4o-mini)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>100</td>
          <td>1,000</td>
          <td>1,000</td>
          <td>~$0.15</td>
      </tr>
      <tr>
          <td>1,000</td>
          <td>10,000</td>
          <td>10,000</td>
          <td>~$1.50</td>
      </tr>
      <tr>
          <td>10,000</td>
          <td>100,000</td>
          <td>100,000</td>
          <td>~$15.00</td>
      </tr>
  </tbody>
</table>
<p>This is a one-time indexing cost. Query costs remain the same.</p>
<h2 id="measuring-improvement">Measuring Improvement</h2>
<p>Track these metrics before and after:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#cf222e">def</span> <span style="color:#6639ba">evaluate_retrieval</span><span style="color:#1f2328">(</span>queries<span style="color:#1f2328">:</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">],</span> ground_truth<span style="color:#1f2328">:</span> <span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">list</span><span style="color:#1f2328">[</span><span style="color:#6639ba">str</span><span style="color:#1f2328">]]):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0a3069">&#34;&#34;&#34;Evaluate retrieval quality.&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    hits <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>    total <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> query<span style="color:#1f2328">,</span> expected_chunks <span style="color:#0550ae">in</span> <span style="color:#6639ba">zip</span><span style="color:#1f2328">(</span>queries<span style="color:#1f2328">,</span> ground_truth<span style="color:#1f2328">):</span>
</span></span><span style="display:flex;"><span>        results <span style="color:#0550ae">=</span> contextual_search<span style="color:#1f2328">(</span>query<span style="color:#1f2328">,</span> n_results<span style="color:#0550ae">=</span><span style="color:#0550ae">5</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>        retrieved_ids <span style="color:#0550ae">=</span> <span style="color:#1f2328">[</span>r<span style="color:#1f2328">[</span><span style="color:#0a3069">&#34;id&#34;</span><span style="color:#1f2328">]</span> <span style="color:#cf222e">for</span> r <span style="color:#0550ae">in</span> results<span style="color:#1f2328">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> expected <span style="color:#0550ae">in</span> expected_chunks<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>            total <span style="color:#0550ae">+=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>            <span style="color:#cf222e">if</span> expected <span style="color:#0550ae">in</span> retrieved_ids<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>                hits <span style="color:#0550ae">+=</span> <span style="color:#0550ae">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    recall <span style="color:#0550ae">=</span> hits <span style="color:#0550ae">/</span> total
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> recall
</span></span></code></pre></div><p>Anthropic&rsquo;s benchmarks show:</p>
<ul>
<li><strong>Standard RAG recall:</strong> ~60%</li>
<li><strong>Contextual RAG recall:</strong> ~84%</li>
<li><strong>Contextual + Hybrid:</strong> ~95%</li>
</ul>
<h2 id="complete-example">Complete Example</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#57606a"># Full pipeline</span>
</span></span><span style="display:flex;"><span>document <span style="color:#0550ae">=</span> <span style="color:#6639ba">open</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;quarterly_report.md&#34;</span><span style="color:#1f2328">)</span><span style="color:#0550ae">.</span>read<span style="color:#1f2328">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 1. Create contextual chunks</span>
</span></span><span style="display:flex;"><span>chunks <span style="color:#0550ae">=</span> create_contextual_chunks<span style="color:#1f2328">(</span>document<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 2. Index</span>
</span></span><span style="display:flex;"><span>index_contextual_chunks<span style="color:#1f2328">(</span>chunks<span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># 3. Query</span>
</span></span><span style="display:flex;"><span>results <span style="color:#0550ae">=</span> contextual_search<span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;What was the European performance?&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">for</span> r <span style="color:#0550ae">in</span> results<span style="color:#1f2328">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Context: </span><span style="color:#0a3069">{</span>r<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;context&#39;</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">f</span><span style="color:#0a3069">&#34;Content: </span><span style="color:#0a3069">{</span>r<span style="color:#1f2328">[</span><span style="color:#0a3069">&#39;text&#39;</span><span style="color:#1f2328">][:</span><span style="color:#0550ae">200</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">...&#34;</span><span style="color:#1f2328">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">print</span><span style="color:#1f2328">(</span><span style="color:#0a3069">&#34;---&#34;</span><span style="color:#1f2328">)</span>
</span></span></code></pre></div><h2 id="whats-next">What&rsquo;s Next</h2>
<p>Contextual RAG is one technique in the Advanced RAG toolkit. Other improvements to explore:</p>
<ul>
<li><strong>Query rewriting:</strong> Transform user queries before retrieval</li>
<li><strong>Reranking:</strong> Use a cross-encoder to rerank retrieved results</li>
<li><strong>Document hierarchies:</strong> Maintain parent-child relationships between chunks</li>
<li><strong>Late chunking:</strong> Embed full documents, then chunk the embeddings</li>
</ul>
<p>The key insight: RAG quality is mostly about retrieval quality. Invest in making your chunks as searchable as possible, and everything downstream improves.</p>
<hr>
<h2 id="try-it-yourself">Try It Yourself</h2>
<p>Copy this prompt into your AI coding agent to build this project:</p>
<pre tabindex="0"><code>Build a Contextual RAG pipeline that improves retrieval by adding context:
1. A context generator that uses an LLM to describe each chunk&#39;s position
2. A chunking pipeline that prepends context to chunks before embedding
3. A ChromaDB vector store that indexes contextualized text
4. A hybrid retriever combining BM25 and vector search with alpha weighting

Include caching for context generation using MD5 hashes. Test with a
hierarchical document (with headers/sections) and show how contextual
chunks improve retrieval for queries referencing section context.
</code></pre>
    <div class="jovis-ad">
    <div class="jovis-ad-badge">â— Intelligence at Every Action</div>
    <h3 class="jovis-ad-headline">AI Native<br><span class="jovis-ad-cyan">Project Management</span></h3>
    <p class="jovis-ad-description">Stop using tools that bolt on AI as an afterthought. Jovis is built AI-first â€” smart routing, proactive monitoring, and intelligent workflows from the ground up.</p>
    <div class="jovis-ad-buttons">
        <a class="jovis-ad-cta" href="https://jovis.ai?utm_source=blog&utm_medium=post_footer">Get early access â†’</a>
        <a class="jovis-ad-secondary" href="https://jovis.ai?utm_source=blog&utm_medium=post_footer&utm_content=how_it_works">See how it works</a>
    </div>
</div>

    <hr class="footer-separator" />
<div class="tags">
    
    
    <ul class="flat">
        
        
        <li class="tag-li"><a href="/tags/ai">AI</a>
        </li>
        
        
        <li class="tag-li"><a href="/tags/rag">RAG</a>
        </li>
        
        
        <li class="tag-li"><a href="/tags/retrieval">Retrieval</a>
        </li>
        
        
        <li class="tag-li"><a href="/tags/python">Python</a>
        </li>
        
        
        <li class="tag-li"><a href="/tags/tutorial">Tutorial</a>
        </li>
        
    </ul>
    
    
</div>



<div class="back">
    <a href="https://notes.muthu.co/"><span aria-hidden="true">â† Back</span></a>
</div>


<div class="back">
    
</div>

</div>

	</div>
	

	<div class="grid-overlay visible" id="grid-overlay">
	<div class="grid-overlay-baseline"></div>
	<div class="grid-overlay-columns">
		<div></div><div></div><div></div><div></div>
		<div></div><div></div><div></div><div></div>
		<div></div><div></div><div></div><div></div>
	</div>
</div>


<div class="footer wrapper">
	<nav class="nav">
		<div>&copy 2025   Muthukrishnan</div>
		<div>Contact: muthukrishnan.t [at] hotmail [dot] com</div>
	</nav>
</div><script>feather.replace()</script>

	
</body>

</html>
